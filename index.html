<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surprivo | Referral Tracking</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=IBM+Plex+Mono:wght@300;500&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- PapaParse & Confetti -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cream': '#f9f7f2',
                        'paper': '#ffffff',
                        'ink': '#1a1a1a',
                        'gold': '#8a7044',
                        'border-soft': '#e5e1d8',
                    },
                    fontFamily: {
                        display: ['"DM Serif Display"', 'serif'],
                        mono: ['"IBM Plex Mono"', 'monospace'],
                        sans: ['"DM Sans"', 'sans-serif'],
                    },
                    animation: {
                        'reveal-card': 'revealCard 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fadeIn 1s ease-out forwards',
                    },
                    keyframes: {
                        revealCard: {
                            '0%': { transform: 'translateY(30px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #f9f7f2; 
            color: #1a1a1a;
            background-image: 
                linear-gradient(#e5e1d8 1px, transparent 1px),
                linear-gradient(90deg, #e5e1d8 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: center center;
        }
        .shadow-editorial {
            box-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(0, 0, 0, 0.05);
        }
        .custom-progress {
            transition: width 1.5s cubic-bezier(0.65, 0, 0.35, 1);
        }
        .loader {
            width: 24px; height: 24px;
            border: 2px solid #8a704422;
            border-top-color: #8a7044;
            display: inline-block;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start py-12 px-6 font-sans">

    <header class="text-center mb-12 animate-fade-in">
        <div class="inline-block border-2 border-ink px-8 py-4 mb-6">
            <h1 class="font-display text-6xl md:text-7xl font-normal uppercase tracking-tighter text-ink leading-none">Surprivo</h1>
        </div>
        <div class="flex flex-col items-center">
            <span class="font-mono text-[10px] tracking-[0.6em] uppercase text-gold font-bold">Referral Tracking System</span>
            <div class="h-10 w-[1px] bg-ink/10 mt-4"></div>
        </div>
    </header>

    <main class="w-full max-w-2xl">
        <div class="bg-paper p-2 rounded-none border border-ink shadow-editorial mb-16">
            <div class="flex flex-col md:flex-row items-stretch gap-1">
                <div class="flex-1 flex flex-col justify-center py-2">
                    <input 
                        type="text" 
                        id="referralCode" 
                        placeholder="ENTER THE REFERRAL CODE"
                        class="bg-transparent px-6 py-3 font-mono text-base md:text-lg focus:outline-none uppercase placeholder:text-ink/20 text-center md:text-left w-full font-bold tracking-tight"
                        oninput="handleInput(this)"
                    >
                    <span id="inputHint" class="px-6 text-[9px] font-mono text-ink/40 text-center md:text-left uppercase tracking-widest transition-opacity duration-300">eg. TVR-XXXX-123</span>
                </div>
                <button 
                    onclick="trackReferral()"
                    class="bg-ink text-cream font-mono px-12 py-5 uppercase tracking-[0.2em] font-bold hover:bg-gold transition-all active:scale-95 text-xs whitespace-nowrap"
                >
                    Validate Code
                </button>
            </div>
        </div>

        <div id="welcomeInfo" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12 opacity-60">
            <div class="border border-border-soft p-6 bg-paper/50">
                <p class="font-mono text-[10px] uppercase text-gold mb-2 font-bold">Step 01</p>
                <p class="font-sans text-xs leading-relaxed text-ink/70">Share your unique referral code with friends.</p>
            </div>
            <div class="border border-border-soft p-6 bg-paper/50">
                <p class="font-mono text-[10px] uppercase text-gold mb-2 font-bold">Step 02</p>
                <p class="font-sans text-xs leading-relaxed text-ink/70">When 3 friends join, your box is unlocked.</p>
            </div>
            <div class="border border-border-soft p-6 bg-paper/50">
                <p class="font-mono text-[10px] uppercase text-gold mb-2 font-bold">Step 03</p>
                <p class="font-sans text-xs leading-relaxed text-ink/70">Track your progress live here.</p>
            </div>
        </div>

        <div id="loader" class="hidden flex flex-col items-center py-12">
            <div class="loader"></div>
            <p class="mt-4 font-mono text-[9px] text-ink tracking-[0.4em] uppercase">Searching Ledger</p>
        </div>

        <div id="errorCard" class="hidden animate-reveal-card bg-paper border border-ink p-12 text-center shadow-editorial">
            <h3 class="font-display text-3xl mb-4 uppercase tracking-tighter">No Referral Found</h3>
            <p class="text-ink/60 text-sm mb-8 font-sans leading-relaxed max-w-xs mx-auto">
                Sorry, no referral found for this code üòî<br>Start by filling our survey!
            </p>
            <a href="https://forms.gle/WVhmAFCRcaFkQ2rc9" target="_blank" class="inline-block font-mono text-[10px] uppercase tracking-[0.3em] bg-ink text-white px-8 py-4 hover:bg-gold transition-colors">
                Start Survey &rarr;
            </a>
        </div>

        <div id="resultCard" class="hidden animate-reveal-card">
            <article class="bg-paper border border-ink shadow-editorial overflow-hidden">
                <div class="p-10 md:p-14 text-center border-b border-border-soft">
                    <p class="font-mono text-[10px] text-gold uppercase tracking-[0.4em] mb-4">Member Record</p>
                    <h2 id="displayName" class="font-display text-5xl md:text-6xl text-ink uppercase tracking-tighter mb-6">Hi Reader!</h2>
                    <div class="inline-block px-6 py-2 border border-ink/10">
                        <span id="displayCode" class="font-mono text-[11px] text-ink/50 tracking-[0.3em] font-bold">---</span>
                    </div>
                </div>

                <div class="p-10 md:p-14">
                    <section class="mb-16">
                        <div class="flex justify-between items-end mb-8">
                            <div class="space-y-1">
                                <h4 class="font-mono text-[10px] uppercase tracking-[0.3em] text-gold font-bold">Tier Progress</h4>
                                <p id="statusHero" class="font-sans text-sm font-bold text-ink uppercase tracking-tight">Active Status Found</p>
                            </div>
                            <span id="statusEmoji" class="text-3xl grayscale">üì§</span>
                        </div>
                        <div class="h-4 w-full bg-cream border border-border-soft p-1">
                            <div id="progressBar" class="h-full bg-ink custom-progress"></div>
                        </div>
                        <div class="mt-4 flex justify-between font-mono text-[9px] text-ink/50 uppercase tracking-[0.2em] font-bold">
                            <span>Entry</span>
                            <span id="progressText" class="text-ink">0%</span>
                            <span>Unlocked</span>
                        </div>
                    </section>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-px bg-border-soft border border-border-soft mb-12">
                        <div class="bg-paper p-8">
                            <label class="block font-mono text-[9px] uppercase tracking-widest text-gold mb-3 font-bold">Estimated Dispatch</label>
                            <span id="gridExpectedDate" class="font-display text-2xl uppercase tracking-tighter">---</span>
                        </div>
                        <div class="bg-paper p-8 text-right">
                            <label class="block font-mono text-[9px] uppercase tracking-widest text-gold mb-3 font-bold">Total Referrals</label>
                            <span id="gridReferredCount" class="font-display text-2xl uppercase tracking-tighter">0 / 3</span>
                        </div>
                    </div>

                    <section class="pt-10">
                        <h5 class="font-mono text-[9px] uppercase tracking-[0.5em] text-ink/40 mb-10 text-center">Activity Log</h5>
                        <div class="space-y-4" id="timelineContainer"></div>
                    </section>

                    <div id="winnerBanner" class="hidden mt-12 bg-ink text-cream p-10 text-center animate-reveal-card">
                        <h3 class="font-display text-3xl uppercase tracking-tighter mb-2">Claim Verified</h3>
                        <p class="font-mono text-[10px] uppercase tracking-[0.4em] opacity-60">Your free box has been allocated</p>
                    </div>
                </div>
            </article>
        </div>
    </main>

    <footer class="mt-24 text-center pb-12 w-full max-w-xl border-t border-border-soft pt-12">
        <div class="flex flex-col items-center gap-6">
            <div class="space-y-2">
                <p class="font-mono text-[10px] text-ink/60 uppercase tracking-widest font-bold">
                    ¬© 2026 Surprivo. Updated: <span id="footerTimestamp"></span>
                </p>
                <p class="font-sans text-[11px] text-ink/40 font-medium">Made with ‚ù§Ô∏è for book lovers</p>
            </div>
        </div>
    </footer>

    <script>
        const CONFIG = {
            SHEET_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQUuTtKd5-2vcGIMAYxIGxSJd9j26G16lLf80fTgdHWbak3bjJwa6csjSI9C8YndzT09ETta6GUfDAY/pub?output=csv',
            PROXIES: [
                'https://api.allorigins.win/raw?url=',
                'https://corsproxy.io/?',
                'https://thingproxy.freeboard.io/fetch/',
                'https://api.codetabs.com/v1/proxy?quest='
            ],
            // FIXED MAPPINGS FOR YOUR SHEET
            COL_SEARCH_KEY: 20,    // Column U (Referral Code)
            COL_NAME: 2,          // Column C (Name)
            COL_REF_COUNT: 21,    // Column V (Completion Count)
            COL_EXPECTED_DATE: 22, // Column W (Expected Date)
            COL_LOGS: 23,          // Column X (Activity Logs)
            
            STATUS: {
                0: { pct: 5, emoji: 'üì§', hero: 'JOURNEY INITIALIZED' },
                1: { pct: 33, emoji: 'üëç', hero: 'FIRST MILESTONE REACHED' },
                2: { pct: 67, emoji: 'üî•', hero: 'SECOND MILESTONE REACHED' },
                3: { pct: 100, emoji: 'üéâ', hero: 'COMPLETION VERIFIED' }
            }
        };

        function handleInput(input) {
            const hint = document.getElementById('inputHint');
            hint.style.opacity = input.value.length > 0 ? '0' : '1';
        }

        function updateTimestamp() {
            const now = new Date();
            document.getElementById('footerTimestamp').textContent = now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        updateTimestamp();

        document.getElementById('referralCode').addEventListener('keypress', e => {
            if (e.key === 'Enter') trackReferral();
        });

        const wait = ms => new Promise(res => setTimeout(res, ms));

        async function fetchWithFailover(url) {
            const finalUrl = `${url}&cachebust=${Date.now()}`;
            try {
                const response = await fetch(finalUrl);
                if (response.ok) return await response.text();
            } catch (e) { console.warn("Direct access blocked."); }

            for (let i = 0; i < CONFIG.PROXIES.length; i++) {
                try {
                    await wait(i * 100);
                    const proxyUrl = `${CONFIG.PROXIES[i]}${encodeURIComponent(finalUrl)}`;
                    const response = await fetch(proxyUrl);
                    if (response.ok) {
                        const text = await response.text();
                        if (text && text.length > 50) return text;
                    }
                } catch (e) { console.warn(`Gateway ${i+1} failed.`); }
            }
            throw new Error("Registry Connection Failed");
        }

        async function trackReferral() {
            const input = document.getElementById('referralCode').value.trim();
            if (!input) return;

            const loader = document.getElementById('loader');
            const error = document.getElementById('errorCard');
            const result = document.getElementById('resultCard');
            const welcome = document.getElementById('welcomeInfo');

            error.classList.add('hidden');
            result.classList.add('hidden');
            welcome.classList.add('hidden');
            loader.classList.remove('hidden');

            try {
                const csvData = await fetchWithFailover(CONFIG.SHEET_URL);
                Papa.parse(csvData, {
                    header: false,
                    skipEmptyLines: true,
                    complete: (results) => {
                        loader.classList.add('hidden');
                        if (results.data && results.data.length > 0) {
                            processData(results.data, input);
                        } else {
                            throw new Error("Malformed data");
                        }
                    },
                    error: (err) => { 
                        console.error("Parse Error:", err);
                        showSyncError();
                    }
                });
            } catch (err) {
                console.error("Fetch Error:", err);
                showSyncError();
            }
        }

        function showSyncError() {
            const loader = document.getElementById('loader');
            const welcome = document.getElementById('welcomeInfo');
            const errorBox = document.getElementById('errorCard');
            loader.classList.add('hidden');
            welcome.classList.remove('hidden');
            errorBox.querySelector('h3').textContent = "Connection Sync Issue";
            errorBox.querySelector('p').textContent = "Your browser is restricting access to the referral ledger. Please try disabling 'Enhanced Tracking Protection' or use Chrome.";
            errorBox.classList.remove('hidden');
        }

        function processData(rows, code) {
            let foundRow = null;
            const searchCode = code.toLowerCase();
            
            for (let i = 1; i < rows.length; i++) {
                const rowValue = rows[i][CONFIG.COL_SEARCH_KEY];
                if (rowValue && rowValue.toString().toLowerCase().trim() === searchCode) {
                    foundRow = rows[i];
                    break;
                }
            }

            if (!foundRow) {
                const errorCard = document.getElementById('errorCard');
                errorCard.querySelector('h3').textContent = "No Referral Found";
                errorCard.querySelector('p').innerHTML = "Sorry, no record found for this code üòî<br>Double check your entry!";
                errorCard.classList.remove('hidden');
                return;
            }

            renderCard(foundRow);
        }

        function renderCard(row) {
            const count = Math.min(Math.max(parseInt(row[CONFIG.COL_REF_COUNT]) || 0, 0), 3);
            const status = CONFIG.STATUS[count];
            
            document.getElementById('displayName').textContent = `HI ${row[CONFIG.COL_NAME] || 'READER'}! üëã`;
            document.getElementById('displayCode').textContent = `ID: ${row[CONFIG.COL_SEARCH_KEY]}`;
            document.getElementById('gridExpectedDate').textContent = row[CONFIG.COL_EXPECTED_DATE] || 'PENDING';
            document.getElementById('gridReferredCount').textContent = `${count} / 3`;
            
            const bar = document.getElementById('progressBar');
            bar.style.width = '0%';
            setTimeout(() => bar.style.width = `${status.pct}%`, 300);

            document.getElementById('progressText').textContent = `${status.pct}%`;
            document.getElementById('statusEmoji').textContent = status.emoji;
            document.getElementById('statusHero').textContent = status.hero;

            const timeline = document.getElementById('timelineContainer');
            timeline.innerHTML = '';
            
            // Extract and show the log from Column X
            const logEntry = row[CONFIG.COL_LOGS];
            if (logEntry) {
                const div = document.createElement('div');
                div.className = 'border-l-2 border-gold pl-6 py-2 animate-reveal-card';
                div.innerHTML = `<p class="font-sans text-xs uppercase font-bold tracking-tight text-ink/70">${logEntry}</p>`;
                timeline.appendChild(div);
            } else {
                timeline.innerHTML = '<p class="text-center font-mono text-[9px] text-ink/30 uppercase">No recent activity detected</p>';
            }

            if (count === 3) {
                document.getElementById('winnerBanner').classList.remove('hidden');
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.7 }, colors: ['#1a1a1a', '#8a7044'] });
            } else {
                document.getElementById('winnerBanner').classList.add('hidden');
            }

            document.getElementById('resultCard').classList.remove('hidden');
        }
    </script>
</body>
</html>
